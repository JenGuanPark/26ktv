# 部署与测试指南

本指南涵盖了新增的“票据证明上传”功能的部署和测试步骤。

## 1. 部署说明

由于后端涉及数据库字段变更和新的文件存储依赖，请按以下步骤部署：

### Render 部署配置
1.  **文件存储 (Disk)**:
    *   确保 Render Dashboard 中该服务已挂载 Disk。
    *   Mount Path: `/var/data`
    *   Name: `ledger-data` (或您在 `render.yaml` 中定义的名称)
    *   Size: 1GB

2.  **环境变量**:
    *   确保 `UPLOAD_DIR` 环境变量设置为 `/var/data/uploads`。
    *   代码已配置为读取此变量，如果未设置则默认为 `uploads` (仅适用于本地开发)。

3.  **依赖更新**:
    *   `requirements.txt` 已添加 `python-multipart`。
    *   Render 会在下次部署时自动安装此依赖。

4.  **数据库迁移**:
    *   后端启动时会自动检查 `transactions` 表。
    *   如果缺少 `receipt_image_path` 字段，系统会自动执行 `ALTER TABLE` 语句添加该字段。
    *   **无需手动执行 SQL 脚本**。

### 部署步骤
只需将代码推送到 GitHub 仓库，Render 将自动触发重新部署：
```bash
git add .
git commit -m "Add receipt upload feature"
git push
```

---

## 2. 测试指南

### 前端功能测试
1.  **访问应用**: 打开您的 Web 应用链接。
2.  **查看列表**: 在“完整收支明细”表格中，确认最右侧出现了“票据”列。
3.  **手动上传**:
    *   找到一条没有票据的记录。
    *   点击上传按钮（上箭头图标）。
    *   选择一张 JPG 或 PNG 图片。
    *   确认出现“上传成功”提示，且按钮变为图片缩略图。
4.  **查看票据**:
    *   点击缩略图。
    *   确认图片放大显示。
    *   点击图片外部空白区域，确认预览窗口关闭。

### Telegram 集成测试
1.  **发送图片**:
    *   向您的 Telegram 记账机器人发送一张收据/发票图片。
    *   等待机器人回复“图片识别完成，等待填写项目...”。
2.  **确认记录**:
    *   回复具体的消费项目名称（例如“超市购物”）。
    *   等待机器人回复“✅ 已记录...”。
3.  **验证关联**:
    *   回到 Web 前端页面。
    *   刷新列表。
    *   确认刚刚通过 Telegram 创建的记录在“票据”列显示了您发送的图片缩略图。

### 异常处理测试
1.  **非图片文件**: 尝试在前端上传一个非图片文件（如 .txt），后端应拒绝或前端显示错误（取决于浏览器行为，Ant Design Upload 组件通常会限制文件类型，但后端也做了扩展名检查）。
2.  **大文件**: 尝试上传超过服务器限制（通常 Nginx/Render 有默认限制）的文件，确认是否有错误提示。

---

## 3. 故障排查

*   **图片不显示 (404 Not Found)**:
    *   检查 Render 的 Disk 是否正确挂载。
    *   检查 `UPLOAD_DIR` 环境变量是否正确。
    *   确认后端日志中是否有 `Mounted /uploads` 的提示。
*   **上传失败**:
    *   检查后端日志 (Render Logs) 查看具体报错信息。
    *   确认磁盘空间是否已满。
